name: CD

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Where are we deploying?'
        required: true
        default: 'prod-ssh'
        type: choice
        options:
          - prod-ssh
          - staging-future
      confirm_force:
        description: 'Ignore [skip cd]?'
        required: false
        type: boolean
        default: false

env:
  # /etc/systemd/system/<SERVICE_NAME>.service)
  SERVICE_NAME: goproject
  REMOTE_DIR: /opt/goproject
  BINARY_NAME: goproject-linux
  CONFIG_FILE_SOURCE: config/config.prod.yaml
  CONFIG_FILE_TARGET: config/config.prod.yaml

jobs:
  check-ci:
    name: Verify CI Status
    runs-on: ubuntu-latest
    steps:
      - name: Get Commit Status
        id: status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;

            console.log(`Checking CI status for ${ref} at commit ${context.sha}...`);

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch: ref.replace('refs/heads/', ''),
              event: 'push',
              status: 'success',
              per_page: 5
            });

            const ciRun = runs.data.workflow_runs.find(run => run.head_sha === context.sha && run.name === 'CI');

            if (!ciRun) {
              core.setFailed('CI for this commit has not passed yet or failed! Fix the tests first');
            } else {
              console.log('âœ… CI passed successfully.');
            }

  deploy:
    name: Build and Deploy
    needs: check-ci
    runs-on: ubuntu-latest

    if: >
      inputs.deploy_target == 'prod-ssh' &&
      (
        !contains(github.event.head_commit.message, '[skip cd]') ||
        inputs.confirm_force == true
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Generate Build Variables
        id: vars
        run: |
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date +%FT%T%z)" >> $GITHUB_OUTPUT

      - name: Build Binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -trimpath \
            -ldflags "-s -w -X main.CommitHash=${{ steps.vars.outputs.COMMIT_HASH }} -X main.BuildTime=${{ steps.vars.outputs.BUILD_TIME }}" \
            -o build/${{ env.BINARY_NAME }} \
            ./cmd/api/main.go

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Prepare Remote Directory
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ env.REMOTE_DIR }}/config"

      - name: Deploy Files
        run: |
          scp build/${{ env.BINARY_NAME }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_DIR }}/${{ env.BINARY_NAME }}.new

          scp ${{ env.CONFIG_FILE_SOURCE }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.REMOTE_DIR }}/${{ env.CONFIG_FILE_TARGET }}

      - name: Create .env file
        run: |
          echo "${{ secrets.PROD_ENV_FILE }}" | ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cat > ${{ env.REMOTE_DIR }}/.env"

      - name: Switch Binary and Restart
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<EOF
            set -e
            mv ${{ env.REMOTE_DIR }}/${{ env.BINARY_NAME }}.new ${{ env.REMOTE_DIR }}/${{ env.BINARY_NAME }}
            chmod +x ${{ env.REMOTE_DIR }}/${{ env.BINARY_NAME }}

            sudo systemctl restart ${{ env.SERVICE_NAME }}
          EOF

  deploy-staging:
    if: inputs.deploy_target == 'staging-future'
    needs: check-ci
    runs-on: ubuntu-latest
    steps:
      - run: echo "There will be a deployment to staging here"
